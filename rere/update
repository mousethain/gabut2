#!/bin/bash
# ========================================================
# cript Update By : Mousevpn
# ========================================================

# --- KONFIGURASI REPO ---
REPO_URL="https://raw.githubusercontent.com/mousethain/rere"
MAIN_BRANCH="main"
LATEST_VERSION_FILE="$MAIN_BRANCH/VERSION"
LOCAL_VERSION_FILE="/etc/current_version"
UPDATE_CORE_SCRIPT="update_core.sh"
# ------------------------

# Output Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

get_local_version() {
    if [ -f "$LOCAL_VERSION_FILE" ]; then
        cat "$LOCAL_VERSION_FILE" | tr -d '[:space:]' 
    else
        echo "v0.0" 
    fi
}

get_latest_version() {
    LATEST_VERSION=$(curl -sS --retry 5 --fail "$REPO_URL/$LATEST_VERSION_FILE")
    if [ $? -eq 0 ]; then
        echo "$LATEST_VERSION" | tr -d '[:space:]'
    else
        echo "" 
    fi
}

main_update() {
    LOCAL_VER=$(get_local_version)
    LATEST_VER=$(get_latest_version)

    echo -e "${YELLOW}>> Memeriksa Pembaruan... (Versi Terinstal: ${LOCAL_VER})${NC}"

    if [ -z "$LATEST_VER" ]; then
        echo -e "${RED}!! Gagal mengambil informasi versi terbaru dari GitHub. Cek koneksi.${NC}"
        return 1
    fi

    # Cek apakah versi lokal sudah sama atau lebih baru dari versi terbaru
    if [ "$(printf "%s\n" "$LOCAL_VER" "$LATEST_VER" | sort -V | tail -n 1)" = "$LOCAL_VER" ]; then
        echo -e "${YELLOW}i Versi lokal ($LOCAL_VER) sudah terbaru (Versi GitHub: $LATEST_VER).${NC}"
        return 0
    fi

    echo -e "\n${GREEN}==============================================${NC}"
    echo -e "${GREEN}  Pembaruan Tersedia!${NC}"
    echo -e "${GREEN}  Versi Lama: ${YELLOW}${LOCAL_VER}${NC}"
    echo -e "${GREEN}  Versi Baru: ${YELLOW}${LATEST_VER}${NC}"
    echo -e "${GREEN}==============================================${NC}"

    read -r -p "Apakah Anda yakin ingin memperbarui dari ${LOCAL_VER} ke versi ${LATEST_VER}? (y/N): " response
    case "$response" in
        [yY][eE][sS]|[yY])
            echo -e "${YELLOW}>> Memulai update core dari branch ${LATEST_VER}...${NC}"
            
            UPDATE_SCRIPT_URL="$REPO_URL/$LATEST_VER/$UPDATE_CORE_SCRIPT"
            
            if ! wget -q "$UPDATE_SCRIPT_URL" -O /tmp/update_core.sh; then
                echo -e "${RED}!! Gagal mengunduh skrip core update. Proses dibatalkan.${NC}"
                return 1
            fi
            
            chmod +x /tmp/update_core.sh
            
            # --- PERBAIKAN KRITIS UNTUK MENCEGAH ERROR YANG BARU SAJA ANDA LAPORKAN ---
            # Meneruskan versi dan menjalankan skrip core
            bash /tmp/update_core.sh "$LATEST_VER"
            CORE_EXIT_CODE=$? # AMBIL KODE KELUAR DARI update_core.sh
            
            rm -f /tmp/update_core.sh
            
            # Hanya tulis versi baru jika skrip inti berhasil (Exit Code 0)
            if [ $CORE_EXIT_CODE -eq 0 ]; then
                echo "$LATEST_VER" > "$LOCAL_VERSION_FILE"
                echo -e "${GREEN}âœ“ Pembaruan Selesai! Versi sekarang: $LATEST_VER${NC}"
            else
                # Jika skrip inti gagal, jangan ganti versi lokal
                echo -e "${RED}!! Pembaruan GAGAL (Kode Keluar: $CORE_EXIT_CODE). Versi tetap: $LOCAL_VER${NC}"
            fi
            # -----------------------------------------------------------------------
            ;;
        *)
            echo -e "${YELLOW}i Pembaruan dibatalkan.${NC}"
            ;;
    esac
}

main_update
