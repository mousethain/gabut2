#!/usr/bin/env bash
# ========================================================
#               Script Backup By : Mousevpn
# ========================================================

clear

RCLONE_REMOTE="rerechan"
DEFAULT_PASS="Rerechan02" 
DEFAULT_USER="Rerechan02"
# ============================

tanggal=$(date +"%m-%d-%Y")
waktu=$(date +"%H-%M-%S")
random_code=$(openssl rand -hex 4)
zip_file="/root/Backup-${random_code}-${tanggal}-${waktu}.zip"
backup_dir="/root/backup"
botToken=$(cat /usr/local/etc/v2ray/bot.key 2>/dev/null)
chatId=$(cat /usr/local/etc/v2ray/client.id 2>/dev/null)
domain=$(cat /usr/local/etc/v2ray/domain 2>/dev/null || echo "Unknown")
ipsaya=$(curl -s http://checkip.amazonaws.com)
asn_info=$(timeout 5 curl -s "http://ip-api.com/json/$ipsaya" | jq -r '.isp // "Unknown ISP"')

# Warna Output
green() { echo -e "\\033[32;1m${*}\\033[0m"; }
red() { echo -e "\\033[31;1m${*}\\033[0m"; }

echo -e "$(green "Memulai Backup")"
sleep 1

# ------------------------------------------------
#          INPUT USERNAME & PASSWORD
# ------------------------------------------------

# 1. Input Username
echo -e "\n${WHITE}----------------------------------------${NC}"
read -rp "Masukkan Username Sender (Kosongkan untuk default '$DEFAULT_USER'): " user_input
echo -e "${WHITE}----------------------------------------${NC}"

if [ -z "$user_input" ]; then
    USERNAME="$DEFAULT_USER"
    echo -e "$(green "Menggunakan username default untuk backup ini.")"
else
    USERNAME="$user_input"
    echo -e "$(green "Menggunakan username yang dimasukkan.")"
fi
sleep 1

echo -e "\n${WHITE}----------------------------------------${NC}"
read -rp "Masukkan Password Zip Baru (Kosongkan untuk default '$DEFAULT_PASS'): " pass_input
echo -e "${WHITE}----------------------------------------${NC}"

if [ -z "$pass_input" ]; then
    ZIP_PASSWORD="$DEFAULT_PASS"
    echo -e "$(green "Menggunakan password default untuk ZIP.")"
else
    ZIP_PASSWORD="$pass_input"
    echo -e "$(green "Menggunakan password yang dimasukkan untuk ZIP.")"
fi
sleep 1

rm -rf "$backup_dir"
mkdir -p "$backup_dir"
echo -e "$(green "Menyalin file konfigurasi...")"
cp /etc/passwd /root/backup/ &> /dev/null
cp /etc/group /root/backup/ &> /dev/null
cp /etc/shadow /root/backup/ &> /dev/null
cp /etc/gshadow /root/backup/ &> /dev/null
cp -r /usr/local/etc/v2ray/ /root/backup/v2ray 2>/dev/null
mkdir -p /root/backup/noobzvpns
cp /etc/noobzvpns/db_user.json /root/backup/noobzvpns/ 2>/dev/null
cp /etc/noobzvpns/.noobz.db /root/backup/noobzvpns/ 2>/dev/null
cd /root

echo -e "$(green "Membuat file ZIP terenkripsi...")"
zip -rP "$ZIP_PASSWORD" "$zip_file" "backup" &> /dev/null

if [[ ! -f "$zip_file" ]]; then
    echo -e "$(red "Gagal membuat file ZIP.")"
    exit 1
fi

echo -e "$(green "Mengunggah file ke Google Drive menggunakan remote $RCLONE_REMOTE...")"
rclone copy "$zip_file" "$RCLONE_REMOTE":backup/

url=$(rclone link "$RCLONE_REMOTE":backup/"$(basename "$zip_file")")

if [[ -z "$url" ]]; then
    echo -e "$(red "Gagal mendapatkan link backup. Pastikan Rclone remote '$RCLONE_REMOTE' terkonfigurasi!")"
    exit 1
fi

backup_id=$(echo "$url" | grep -o 'id=[^&]*' | cut -d'=' -f2)
link="https://drive.google.com/u/4/uc?id=${backup_id}&export=download"

message="âœ… <b>Backup Berhasil!</b>

ğŸ†” <b>ID Backup:</b>
<pre>$backup_id</pre>

ğŸ–¥ <b>Informasi Server:</b>
ğŸ“› <b>Nama Pengguna:</b> $USERNAME 
ğŸŒ <b>Domain:</b> $domain
ğŸ¢ <b>ISP:</b> $asn_info
ğŸŒ <b>IP VPS:</b> <pre>$ipsaya</pre>
â° <b>Waktu Backup:</b> $tanggal pukul $waktu

ğŸ“¥ <b>Unduh Backup:</b>
<pre>$link</pre>

ğŸ”¹ <i>File backup telah tersimpan di Google Drive.</i>

ğŸ”’ <b>Keamanan:</b> File backup dilindungi dengan password: <b>$ZIP_PASSWORD</b>
ğŸ”„ Proses backup ini dilakukan secara otomatis untuk menjaga data Anda tetap aman.

âœ¨ <b>Terima kasih telah menggunakan layanan kami!</b>"

if [ -n "$botToken" ] && [ -n "$chatId" ]; then
    curl -s -X POST "https://api.telegram.org/bot$botToken/sendMessage" \
         -d "chat_id=$chatId" \
         --data-urlencode "text=$message" \
         -d "parse_mode=HTML"  &> /dev/null
fi

clear
echo -e "$(green "Backup dan pengiriman notifikasi selesai.")"
echo -e "$(green "Detail Backup:")"
echo -e "ğŸ†” ID Backup: $backup_id"
echo -e "ğŸ–¥ Informasi Server:"
echo -e "â”£ ğŸ“› Nama Pengguna: ${RED}$USERNAME${NC}"
echo -e "â”£ ğŸŒ Domain: $domain"
echo -e "â”£ ğŸ¢ ISP: $asn_info"
echo -e "â”£ ğŸŒ IP VPS: $ipsaya"
echo -e "â”£ â° Waktu Backup: $tanggal pukul $waktu"
echo -e "â”£ ğŸ”’ Password ZIP: ${RED}$ZIP_PASSWORD${NC}"
echo -e "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "ğŸ“¥ Unduh Backup: $link"
rm -rf "$backup_dir"
rm -f "$zip_file"
