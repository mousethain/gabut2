#!/usr/bin/env bash
# ========================================================
# Credit Code By Project Rerechan (FINAL FIX: Password Fleksibel & Remote Variabel)
# ========================================================

clear

# === KONFIGURASI YANG AKAN DIUBAH SCRIPT CHANGE-DRIVE-ACCOUNT ===
RCLONE_REMOTE="rerechan" # <--- JANGAN UBAH INI SECARA MANUAL! AKAN DIUBAH SCRIPT CHANGE-DRIVE-ACCOUNT
DEFAULT_PASS="Rerechan02" 
# ============================

# Variabel lain
USERNAME="Rerechan02"
tanggal=$(date +"%m-%d-%Y")
waktu=$(date +"%H-%M-%S")
random_code=$(openssl rand -hex 4)
zip_file="/root/Backup-${random_code}-${tanggal}-${waktu}.zip"
backup_dir="/root/backup"
botToken=$(cat /usr/local/etc/v2ray/bot.key 2>/dev/null)
chatId=$(cat /usr/local/etc/v2ray/client.id 2>/dev/null)
domain=$(cat /usr/local/etc/v2ray/domain 2>/dev/null || echo "Unknown")
ipsaya=$(curl -s http://checkip.amazonaws.com)
asn_info=$(timeout 5 curl -s "http://ip-api.com/json/$ipsaya" | jq -r '.isp // "Unknown ISP"')

# Fungsi Warna Output
green() { echo -e "\\033[32;1m${*}\\033[0m"; }
red() { echo -e "\\033[31;1m${*}\\033[0m"; }

echo -e "$(green "Memulai Backup")"
sleep 1

# LOGIKA PASSWORD FLEKSIBEL
echo -e "\n${WHITE}----------------------------------------${NC}"
read -rp "Masukkan Password Zip Baru (Kosongkan untuk default '$DEFAULT_PASS'): " user_pass
echo -e "${WHITE}----------------------------------------${NC}"

if [ -z "$user_pass" ]; then
    ZIP_PASSWORD="$DEFAULT_PASS"
else
    ZIP_PASSWORD="$user_pass"
fi
sleep 1

# Buat Direktori Backup & Salin File
rm -rf "$backup_dir"
mkdir -p "$backup_dir"
echo -e "$(green "Menyalin file konfigurasi...")"
cp /etc/passwd /root/backup/ &> /dev/null
cp /etc/group /root/backup/ &> /dev/null
cp /etc/shadow /root/backup/ &> /dev/null
cp /etc/gshadow /root/backup/ &> /dev/null
cp -r /usr/local/etc/v2ray/ /root/backup/v2ray 2>/dev/null
mkdir -p /root/backup/noobzvpns
cp /etc/noobzvpns/db_user.json /root/backup/noobzvpns/ 2>/dev/null
cp /etc/noobzvpns/.noobz.db /root/backup/noobzvpns/ 2>/dev/null
cd /root

# Buat File ZIP dengan Password
echo -e "$(green "Membuat file ZIP terenkripsi...")"
zip -rP "$ZIP_PASSWORD" "$zip_file" "backup" &> /dev/null

if [[ ! -f "$zip_file" ]]; then
    echo -e "$(red "Gagal membuat file ZIP.")"
    exit 1
fi

# Upload ke Google Drive menggunakan variabel remote
echo -e "$(green "Mengunggah file ke Google Drive menggunakan remote $RCLONE_REMOTE...")"
rclone copy "$zip_file" "$RCLONE_REMOTE":backup/

# Dapatkan URL file
url=$(rclone link "$RCLONE_REMOTE":backup/"$(basename "$zip_file")")

if [[ -z "$url" ]]; then
    echo -e "$(red "Gagal mendapatkan link backup. Pastikan Rclone remote '$RCLONE_REMOTE' terkonfigurasi!")"
    exit 1
fi

# ... (Sisa script untuk Telegram dan display CLI) ...

# Ambil ID file
backup_id=$(echo "$url" | grep -o 'id=[^&]*' | cut -d'=' -f2)
link="https://drive.google.com/u/4/uc?id=${backup_id}&export=download"

message="âœ… <b>Backup Berhasil!</b>
...
"

if [ -n "$botToken" ] && [ -n "$chatId" ]; then
    curl -s -X POST "https://api.telegram.org/bot$botToken/sendMessage" \
         -d "chat_id=$chatId" \
         --data-urlencode "text=$message" \
         -d "parse_mode=HTML"  &> /dev/null
fi

clear
echo -e "$(green "Backup dan pengiriman notifikasi selesai.")"
echo -e "$(green "Detail Backup:")"
echo -e "ğŸ†” ID Backup: $backup_id"
echo -e "ğŸ–¥ Informasi Server:"
echo -e "â”£ ğŸ“› Nama Pengguna: $USERNAME"
echo -e "â”£ ğŸŒ Domain: $domain"
echo -e "â”£ ğŸ¢ ISP: $asn_info"
echo -e "â”£ ğŸŒ IP VPS: $ipsaya"
echo -e "â”£ â° Waktu Backup: $tanggal pukul $waktu"
echo -e "â”£ ğŸ”’ Password ZIP: ${RED}$ZIP_PASSWORD${NC}"
echo -e "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "ğŸ“¥ Unduh Backup: $link"
rm -rf "$backup_dir"
rm -f "$zip_file"
