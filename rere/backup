#!/usr/bin/env bash
# ========================================================
# Credit Code By Project Rerechan (Modifikasi Password Fleksibel oleh Gemini)
# ========================================================

clear

# === KONFIGURASI DEFAULT ===
DEFAULT_PASS="Rerechan02" 
USERNAME="Rerechan02"
# ============================

# Variabel Waktu
tanggal=$(date +"%m-%d-%Y")
waktu=$(date +"%H-%M-%S")
random_code=$(openssl rand -hex 4)
zip_file="/root/Backup-${random_code}-${tanggal}-${waktu}.zip"
backup_dir="/root/backup"
botToken=$(cat /usr/local/etc/v2ray/bot.key 2>/dev/null)
chatId=$(cat /usr/local/etc/v2ray/client.id 2>/dev/null)

# Autentikasi dan Informasi Server
domain=$(cat /usr/local/etc/v2ray/domain 2>/dev/null || echo "Unknown")
ipsaya=$(curl -s http://checkip.amazonaws.com)
asn_info=$(timeout 5 curl -s "http://ip-api.com/json/$ipsaya" | jq -r '.isp // "Unknown ISP"')

# Fungsi Warna Output
green() { echo -e "\\033[32;1m${*}\\033[0m"; }
red() { echo -e "\\033[31;1m${*}\\033[0m"; }

echo -e "$(green "Memulai Backup")"
sleep 1

# ------------------------------------------------
# LOGIKA PASSWORD FLEKSIBEL BARU
# ------------------------------------------------
echo -e "\n${WHITE}----------------------------------------${NC}"
read -rp "Masukkan Password Zip Baru (Kosongkan untuk default '$DEFAULT_PASS'): " user_pass
echo -e "${WHITE}----------------------------------------${NC}"

# Tentukan password yang akan digunakan untuk ZIP
if [ -z "$user_pass" ]; then
    ZIP_PASSWORD="$DEFAULT_PASS"
    echo -e "$(green "Menggunakan password default untuk backup ini.")"
else
    ZIP_PASSWORD="$user_pass"
    echo -e "$(green "Menggunakan password yang dimasukkan untuk backup ini.")"
fi
sleep 1

# Buat Direktori Backup
rm -rf "$backup_dir"
mkdir -p "$backup_dir"

# Salin File yang Akan Dibackup
echo -e "$(green "Menyalin file konfigurasi...")"
cp /etc/passwd /root/backup/ &> /dev/null
cp /etc/group /root/backup/ &> /dev/null
cp /etc/shadow /root/backup/ &> /dev/null
cp /etc/gshadow /root/backup/ &> /dev/null
cp -r /usr/local/etc/v2ray/ /root/backup/v2ray 2>/dev/null
mkdir -p /root/backup/noobzvpns
cp /etc/noobzvpns/db_user.json /root/backup/noobzvpns/ 2>/dev/null
cp /etc/noobzvpns/.noobz.db /root/backup/noobzvpns/ 2>/dev/null
cd /root

# Buat File ZIP dengan Password (Menggunakan Variabel Baru)
echo -e "$(green "Membuat file ZIP terenkripsi...")"
zip -rP "$ZIP_PASSWORD" "$zip_file" "backup" &> /dev/null

if [[ ! -f "$zip_file" ]]; then
    echo -e "$(red "Gagal membuat file ZIP.")"
    exit 1
fi

# Upload ke Google Drive dengan rclone
echo -e "$(green "Mengunggah file ke Google Drive...")"
rclone copy "$zip_file" rerechan:backup/

# Dapatkan URL file
url=$(rclone link rerechan:backup/"$(basename "$zip_file")")

if [[ -z "$url" ]]; then
    echo -e "$(red "Gagal mendapatkan link backup. Pastikan Rclone sudah terkonfigurasi!")"
    exit 1
fi

# Ambil ID file
backup_id=$(echo "$url" | grep -o 'id=[^&]*' | cut -d'=' -f2)
link="https://drive.google.com/u/4/uc?id=${backup_id}&export=download"

# Format Pesan Telegram (HTML)
message="âœ… <b>Backup Berhasil!</b>

ğŸ†” <b>ID Backup:</b>
<pre>$backup_id</pre>

ğŸ–¥ <b>Informasi Server:</b>
ğŸ“› <b>Nama Pengguna:</b> $USERNAME
ğŸŒ <b>Domain:</b> $domain
ğŸ¢ <b>ISP:</b> $asn_info
ğŸŒ <b>IP VPS:</b> <pre>$ipsaya</pre>
â° <b>Waktu Backup:</b> $tanggal pukul $waktu

ğŸ“¥ <b>Unduh Backup:</b>
<pre>$link</pre>

ğŸ”¹ <i>File backup telah tersimpan di Google Drive.</i>
ğŸ”¹ <i>Simpan ID backup ini untuk referensi pemulihan di masa mendatang.</i>

ğŸ”’ <b>Keamanan:</b> File backup dilindungi dengan password: <b>$ZIP_PASSWORD</b>
ğŸ”„ Proses backup ini dilakukan secara otomatis untuk menjaga data Anda tetap aman.

âœ¨ <b>Terima kasih telah menggunakan layanan kami!</b>"

# Kirim pesan ke Telegram
if [ -n "$botToken" ] && [ -n "$chatId" ]; then
    curl -s -X POST "https://api.telegram.org/bot$botToken/sendMessage" \
         -d "chat_id=$chatId" \
         --data-urlencode "text=$message" \
         -d "parse_mode=HTML"  &> /dev/null
    echo -e "$(green "Pesan notifikasi Telegram telah terkirim.")"
else
    echo -e "$(red "Gagal mengirim notifikasi Telegram. (botToken/chatId tidak ditemukan).")"
fi

# Tampilkan Detail ke CLI
clear
echo -e "$(green "Backup dan pengiriman notifikasi selesai.")"
echo -e "$(green "Detail Backup:")"
echo -e "ğŸ†” ID Backup: $backup_id"
echo -e "ğŸ–¥ Informasi Server:"
echo -e "â”£ ğŸ“› Nama Pengguna: $USERNAME"
echo -e "â”£ ğŸŒ Domain: $domain"
echo -e "â”£ ğŸ¢ ISP: $asn_info"
echo -e "â”£ ğŸŒ IP VPS: $ipsaya"
echo -e "â”£ â° Waktu Backup: $tanggal pukul $waktu"
echo -e "â”£ ğŸ”’ Password ZIP: ${RED}$ZIP_PASSWORD${NC}"
echo -e "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "ğŸ“¥ Unduh Backup: $link"
rm -rf "$backup_dir"
rm -f "$zip_file" # Menghapus file ZIP lokal setelah selesai
