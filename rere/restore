#!/usr/bin/env bash
# ========================================================
#               Script Restore By : Mousevpn
# ========================================================

clear

backup_dir="/root"
backup_file=$(ls $backup_dir/*.zip 2>/dev/null | head -n 1)

# warna output
green() { echo -e "\033[32;1m${*}\033[0m"; }
red() { echo -e "\033[31m${*}\033[0m"; }
export NC='\033[0m'
echo -e "$(green "Memulai proses restore...")"

# ------------------------------------------------
#            Cek & Instalasi Dependensi 
# ------------------------------------------------

if ! command -v python3 &>/dev/null || ! command -v pip3 &>/dev/null || ! command -v unzip &>/dev/null; then
    echo -e "$(green "Menginstal paket dasar (Python3, pip3, unzip, build-essential)...")"
    apt update -o Acquire::Check-Valid-Until=false && \
    apt install -y python3 python3-pip build-essential unzip || \
    { echo -e "$(red "Gagal menginstal dependensi dasar!")"; exit 1; }
fi

if ! command -v gdown &>/dev/null; then
    echo -e "$(green "Menginstal gdown (untuk mengunduh file backup)...")"
    pip3 install --no-cache-dir gdown --break-system-packages || \
    { echo -e "$(red "Gagal menginstal gdown!")"; exit 1; }
fi

if ! command -v rclone &>/dev/null; then
    echo -e "$(red "PERINGATAN: Rclone tidak terinstal. Restore akan berjalan, tetapi Backup akan gagal!")"
fi

# ------------------------------------------------
#          Restore Data & Pengunduhan
# ------------------------------------------------

if [ -z "$backup_file" ]; then
    echo -e "$(green "Tidak ditemukan file backup (.zip) lokal. Memulai pengunduhan...")"
    input=""
    while [ -z "$input" ]; do
        read -rp "Masukkan ID Google Drive / URL Backup: " input
        if [[ "$input" =~ ^(http|https) ]]; then
            backup_url="$input"
        else
            backup_url="https://drive.google.com/uc?id=${input}&export=download"
        fi
    done

    gdown --fuzzy -O "$backup_dir/rebackup.zip" "$backup_url"

    if [[ $? -ne 0 ]]; then
        echo -e "$(red "Gagal mengunduh file backup! Pastikan ID/URL benar.")"
        exit 1
    fi

    backup_file="$backup_dir/rebackup.zip"
    echo -e "$(green "File backup berhasil diunduh: $backup_file")"
fi

# ------------------------------------------------
#                   PASSWORD
# ------------------------------------------------

DEFAULT_PASS="Rerechan02"
UNZIP_PASS=""

echo -e "\n${WHITE}----------------------------------------${NC}"
read -rp "Masukkan Password Zip Backup (Kosongkan untuk default '$DEFAULT_PASS'): " user_pass
echo -e "${WHITE}----------------------------------------${NC}"

if [ -z "$user_pass" ]; then
    UNZIP_PASS="$DEFAULT_PASS"
    echo -e "$(green "Menggunakan password default.")"
else
    UNZIP_PASS="$user_pass"
    echo -e "$(green "Menggunakan password yang dimasukkan.")"
fi

unzip -P "$UNZIP_PASS" -o "$backup_file" -d "/root/backup_temp"

if [[ $? -ne 0 ]]; then
    echo -e "$(red "Gagal mengekstrak file backup! Password salah atau File Corrupt.")"
    exit 1
fi

# ------------------------------------------------
#              RESTORE & PEMBERSIHAN
# ------------------------------------------------
echo -e "$(green "Memulai proses pemulihan data...")"
cd /root/backup_temp
cp -r v2ray /usr/local/etc/
cp -r noobzvpns /etc/
cp /root/backup_temp/passwd /etc/ &> /dev/null
cp /root/backup_temp/group /etc/ &> /dev/null
cp /root/backup_temp/shadow /etc/ &> /dev/null
cp /root/backup_temp/gshadow /etc/ &> /dev/null

echo -e "$(green "Restore selesai. Membersihkan file sementara...")"

rm -rf /root/backup_temp
rm -f "$backup_file"

echo -e "$(green "Sistem berhasil dipulihkan.")"
echo -e "$(green "Anda mungkin perlu menjalankan 'menu' dan memilih Restart All Service (Opsi 10).")"
