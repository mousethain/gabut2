#!/usr/bin/env bash
# ========================================================
# Script: change-drive-account (FINAL FIX: Remote Update Otomatis - Robust SED)
# ========================================================

# === KONSTANTA & WARNA ===
RED='\e[31m'
GREEN='\e[32m'
WHITE='\e[97m'
NC='\e[0m' 
CONF_FILE="/root/.config/rclone/rclone.conf"
MAX_ATTEMPTS=3
# Daftar file yang perlu diupdate nama remotenya
FILES_TO_UPDATE="/usr/local/sbin/backup /usr/local/sbin/restore" 
# ========================

clear
echo -e "${WHITE}────────────────────────────${NC}"
echo -e "${GREEN}  GANTI AKUN GOOGLE DRIVE (OTOMATIS) ${NC}"
echo -e "${WHITE}────────────────────────────${NC}"

# 1. Cek Nama Remote Aktif Saat Ini
# Mencari variabel RCLONE_REMOTE di script backup dan mengambil nilainya
OLD_REMOTE_NAME=$(grep 'RCLONE_REMOTE=' /usr/local/sbin/backup 2>/dev/null | cut -d'"' -f2)

if [ -z "$OLD_REMOTE_NAME" ]; then
    # Fallback ke default lama jika gagal membaca variabel
    OLD_REMOTE_NAME="rerechan" 
fi

echo -e "Nama remote AKTIF saat ini: ${RED}${OLD_REMOTE_NAME}${NC}"
read -rp "Masukkan NAMA REMOTE BARU (cth: 'mousevpn', tanpa spasi): " NEW_REMOTE_NAME

if [ -z "$NEW_REMOTE_NAME" ]; then
    echo -e "${RED}Nama remote tidak boleh kosong! Proses dibatalkan.${NC}"
    sleep 2
    menu-backup
    exit 1
fi

# ... (Logika Konfirmasi dan rm -f $CONF_FILE tetap sama) ...
read -p "⚠️ PERINGATAN: Konfigurasi Rclone lama akan dihapus. Lanjut? (y/n): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo -e "\n${GREEN}Proses dibatalkan.${NC}"
    sleep 2
    menu-backup
    exit 0
fi

rm -f $CONF_FILE
echo -e "${GREEN}Konfigurasi Rclone lama telah dihapus.${NC}"

# ----------------------------------------------------
# LOOP VERIFIKASI Rclone Config (Tetap sama)
# ----------------------------------------------------
ATTEMPTS=0
while [ ! -f "$CONF_FILE" ] && [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
    ATTEMPTS=$((ATTEMPTS + 1))
    echo -e "\n${GREEN}================== INSTRUKSI OTORISASI (Percobaan $ATTEMPTS/$MAX_ATTEMPTS) ===================${NC}"
    echo -e "1. Ketik ${WHITE}'n'${NC} (New remote)."
    echo -e "2. Beri nama remote: ${RED}${NEW_REMOTE_NAME}${NC}" 
    echo -e "3. Pilih nomor ${WHITE}'drive'${NC} (Google Drive)."
    echo -e "4. Pilih ${WHITE}1${NC} untuk 'Full access'."
    echo -e "5. Di semua pertanyaan lainnya (client_id, secret, service_account), tekan ${WHITE}ENTER${NC}."
    echo -e "6. Pada pertanyaan 'Edit advanced config?' dan 'Use auto config?', jawab ${WHITE}'n'${NC}."
    echo -e "7. Saat muncul ${RED}config_token>${NC}, jalankan ${WHITE}rclone authorize${NC} di Termux/PC Anda untuk mendapatkan token."
    echo -e "8. Setelah selesai, ${WHITE}KETIK 'q' UNTUK KELUAR & SIMPAN.${NC}"
    echo -e "================================================${NC}\n"
    sleep 2
    
    echo -e "${GREEN}Memulai Rclone Config Interaktif...${NC}"
    rclone config
    
    if [ ! -f "$CONF_FILE" ]; then
        echo -e "\n${RED}⚠️ GAGAL! File konfigurasi ($CONF_FILE) belum dibuat. (Pastikan Anda mengetik 'q' untuk keluar).${NC}"
        read -n 1 -s -r -p "Tekan tombol apa saja untuk mencoba lagi..."
        clear
    fi
done

# ----------------------------------------------------
# HASIL AKHIR & OTOMATISASI SCRIPT (FIXED SED LOGIC)
# ----------------------------------------------------
if [ -f "$CONF_FILE" ]; then
    echo -e "\n${GREEN}✅ Konfigurasi Rclone baru Selesai!${NC}"
    
    # Logika Otomatis Update Script
    echo -e "${WHITE}────────────────────────────${NC}"
    echo -e "${GREEN}Mengubah variabel remote di script backup & restore...${NC}"
    
    for file in $FILES_TO_UPDATE; do
        if [ -f "$file" ]; then
            # Menggunakan SED yang lebih kuat: mengganti nilai variabel RCLONE_REMOTE
            sed -i "s|RCLONE_REMOTE=\"${OLD_REMOTE_NAME}\"|RCLONE_REMOTE=\"${NEW_REMOTE_NAME}\"|g" "$file"
            echo -e "   - ${GREEN}SUCCESS:${NC} ${file}"
        else
             echo -e "   - ${RED}SKIP:${NC} ${file} tidak ditemukan."
        fi
    done
    
    # Pengecekan setelah perubahan
    NEW_REMOTE_IN_SCRIPT=$(grep 'RCLONE_REMOTE=' /usr/local/sbin/backup 2>/dev/null | cut -d'"' -f2)
    
    if [ "$NEW_REMOTE_IN_SCRIPT" == "$NEW_REMOTE_NAME" ]; then
        echo -e "\nScript ${WHITE}backup${NC} dan ${WHITE}restore${NC} kini terhubung ke remote ${WHITE}${NEW_REMOTE_NAME}${NC}."
    else
        echo -e "\n${RED}❌ PERINGATAN KRITIS:${NC} Gagal memperbarui nama remote di script! Script mungkin masih menggunakan '${OLD_REMOTE_NAME}'."
        echo -e "Silakan edit /usr/local/sbin/backup dan /usr/local/sbin/restore secara manual dan ganti 'RCLONE_REMOTE=\"${OLD_REMOTE_NAME}\"' menjadi 'RCLONE_REMOTE=\"${NEW_REMOTE_NAME}\"'."
    fi

else
    echo -e "\n${RED}❌ GAGAL TOTAL! Konfigurasi Rclone gagal dibuat.${NC}"
fi

echo -e "Kembali ke Menu Database dalam 5 detik..."
sleep 5
menu-backup
