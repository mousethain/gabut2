#!/usr/bin/env bash
# ========================================================
# Credit Code By mousevpn
# Author: mousevpn
# License: This configuration is licensed for personal or internal use only.
#          Redistribution, resale, or reuse of this code in any form
#          without explicit written permission from the author is prohibited.
#          Selling this code or its derivatives is strictly forbidden.
# ========================================================

JSON_FILE="/etc/noobzvpns/db_user.json"

# Warna terminal
RED='\033[0;31m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m'

get_blocked_status() {
  local blocked="$1"
  if [ "$blocked" == "true" ]; then
    echo -e "${RED}true${NC}"
  else
    echo -e "${GREEN}false${NC}"
  fi
}

display_user_info() {
  local user="$1"
  local blocked="$2"
  echo -e "${BOLD}Username         :${NC} $user"
  echo -e "Blocked          : $blocked"
  echo -e "------------------------------"
}

check_json_file() {
  if [ ! -f "$JSON_FILE" ]; then
    echo -e "${RED}404 Not Found${NC}: File Database Not Found"
    echo -e "${RED}API Response${NC}: {\"error\": \"File not found\"}"
    exit 1
  fi

  if [ ! -s "$JSON_FILE" ]; then
    echo -e "${RED}404 Not Found${NC}: File is empty"
    echo -e "${RED}API Response${NC}: {\"error\": \"File is empty\"}"
    exit 1
  fi

  if ! jq empty "$JSON_FILE" 2>/dev/null; then
    echo -e "${RED}404 Not Found${NC}: Invalid JSON format"
    echo -e "${RED}API Response${NC}: {\"error\": \"Invalid JSON format\"}"
    exit 1
  fi

  echo -e "${GREEN}200 OK${NC}: File found and valid"
}

list_accounts() {
  clear
  check_json_file

  echo -e "${BOLD}List Account Noobzvpns${NC}"
  echo "==========================="

  jq -r '.users | to_entries[] | [.key, .value.blocked] | @tsv' "$JSON_FILE" |
  while IFS=$'\t' read -r user blocked; do
    block_status=$(get_blocked_status "$blocked")
    display_user_info "$user" "$block_status"
  done
}

change_block_status() {
  local username="$1"
  local new_status="$2"

  if [ "$new_status" == "true" ]; then
    noobzvpns block "$username"
  else
    noobzvpns unblock "$username"
  fi

  clear
  echo -e "
Success Change Block Status
=============================
Username      : ${username}@fn-project
Status Blocked: $(get_blocked_status "$new_status")
============================="
}

check_username_validity() {
  local username="$1"

  if jq -e --arg user "$username" '.users[$user]' "$JSON_FILE" > /dev/null; then
    echo -e "${GREEN}200 OK${NC}: Username found"
  else
    echo -e "${RED}404 Not Found${NC}: Username not found"
    exit 1
  fi
}

# Eksekusi utama
list_accounts
read -p "Input Username: " username
check_username_validity "$username"

# Ambil status blokir saat ini
current_status=$(jq -r --arg user "$username" '.users[$user].blocked' "$JSON_FILE")

if [ "$current_status" == "true" ]; then
  echo -e "${BOLD}Status saat ini:${NC} $(get_blocked_status "$current_status")"
  echo -e "${BOLD}Akan di-${GREEN}unblock${NC}..."
  sleep 2
  change_block_status "$username" false
else
  echo -e "${BOLD}Status saat ini:${NC} $(get_blocked_status "$current_status")"
  echo -e "${BOLD}Akan di-${RED}block${NC}..."
  sleep 2
  change_block_status "$username" true
fi
