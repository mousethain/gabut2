#!/usr/bin/env bash
# ========================================================
# Credit Code By mousevpn
# Author: mousevpn
# License: This configuration is licensed for personal or internal use only.
#          Redistribution, resale, or reuse of this code in any form
#          without explicit written permission from the author is prohibited.
#          Selling this code or its derivatives is strictly forbidden.
# ========================================================

clear
##----- Auto Remove Vmess
data=($(cat /usr/local/etc/v2ray/config.json | grep '^###' | cut -d ' ' -f 2 | sort | uniq))
now=$(date +"%Y-%m-%d")
for user in "${data[@]}"; do
    exp=$(grep -w "^### $user" "/usr/local/etc/v2ray/config.json" | cut -d ' ' -f 3 | sort | uniq)
    d1=$(date -d "$exp" +%s)
    d2=$(date -d "$now" +%s)
    exp2=$(((d1 - d2) / 86400))
    if [[ "$exp2" -le "0" ]]; then
        sed -i "/^### $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
        sed -i "/^### $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
    fi
done

#----- Auto Remove Vless
data=($(cat /usr/local/etc/v2ray/config.json | grep '^#&' | cut -d ' ' -f 2 | sort | uniq))
now=$(date +"%Y-%m-%d")
for user in "${data[@]}"; do
    exp=$(grep -w "^#& $user" "/usr/local/etc/v2ray/config.json" | cut -d ' ' -f 3 | sort | uniq)
    d1=$(date -d "$exp" +%s)
    d2=$(date -d "$now" +%s)
    exp2=$(((d1 - d2) / 86400))
    if [[ "$exp2" -le "0" ]]; then
        sed -i "/^#& $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
        sed -i "/^#& $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
    fi
done

#----- Auto Remove Trojan
data=($(cat /usr/local/etc/v2ray/config.json | grep '^#!' | cut -d ' ' -f 2 | sort | uniq))
now=$(date +"%Y-%m-%d")
for user in "${data[@]}"; do
    exp=$(grep -w "^#! $user" "/usr/local/etc/v2ray/config.json" | cut -d ' ' -f 3 | sort | uniq)
    d1=$(date -d "$exp" +%s)
    d2=$(date -d "$now" +%s)
    exp2=$(((d1 - d2) / 86400))
    if [[ "$exp2" -le "0" ]]; then
        sed -i "/^#! $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
        sed -i "/^#! $user $exp/,/^},{/d" /usr/local/etc/v2ray/config.json
    fi
done
systemctl restart v2ray

##------ Auto Remove SSH
hariini=`date +%d-%m-%Y`
cat /etc/shadow | cut -d: -f1,8 | sed /:$/d > /tmp/expirelist.txt
totalaccounts=`cat /tmp/expirelist.txt | wc -l`
for((i=1; i<=$totalaccounts; i++ ))
do
tuserval=`head -n $i /tmp/expirelist.txt | tail -n 1`
username=`echo $tuserval | cut -f1 -d:`
userexp=`echo $tuserval | cut -f2 -d:`
userexpireinseconds=$(( $userexp * 86400 ))
tglexp=`date -d @$userexpireinseconds`             
tgl=`echo $tglexp |awk -F" " '{print $3}'`
while [ ${#tgl} -lt 2 ]
do
tgl="0"$tgl
done
while [ ${#username} -lt 15 ]
do
username=$username" " 
done
bulantahun=`echo $tglexp |awk -F" " '{print $2,$6}'`
todaystime=`date +%s`
if [ $userexpireinseconds -ge $todaystime ] ;
then
:
else
userdel --force $username
fi
done

# Path database NoobzVPN
db_file="/etc/noobzvpns/.noobz.db"
KEY=$(cat /usr/local/etc/v2ray/bot.key)
CHATID=$(cat /usr/local/etc/v2ray/client.id)

# Periksa apakah file database ada
if [[ ! -f "$db_file" ]]; then
    echo "Database tidak ditemukan!"
    exit 1
fi

# Ambil daftar user dari database
while read -r line; do
    # Pastikan hanya membaca baris yang memiliki tag #noobzvpns#
    if [[ "$line" =~ ^#noobzvpns# ]]; then
        name=$(echo "$line" | awk '{print $2}')
        limit=$(echo "$line" | awk '{print $3}')
        expi=$(echo "$line" | awk '{print $4}')

        # Konversi tanggal expired ke format YYYY-MM-DD
        expired_date=$(date -d "$expi" '+%Y-%m-%d' 2>/dev/null)
        today=$(date '+%Y-%m-%d')

        # Jika akun sudah expired, hapus dari database dan sistem
        if [[ "$expired_date" < "$today" ]]; then
            echo "Menghapus akun expired: $name"
            sed -i "/^#noobzvpns# $name $limit $expi/d" "$db_file"
            noobzvpns remove "$name"

            # Kirim notifikasi ke Telegram (Opsional)
            TEKS="ðŸš¨ Akun NoobzVPN Kedaluwarsa Dihapus ðŸš¨
Username: $name
Expired : $expi"
            curl -s --max-time 10 -d "chat_id=$CHATID&text=$TEKS" "https://api.telegram.org/bot$KEY/sendMessage" > /dev/null
        fi
    fi
done < "$db_file"
